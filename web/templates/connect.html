<!DOCTYPE html>
<html>
<head>
    <title>3270Web - Connect</title>
    <link rel="icon" type="image/png" href="/static/3270Web_logo.png">
    <link rel="apple-touch-icon" href="/static/3270Web_logo.png">
    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <script src="/static/theme.js" defer></script>
    <script src="/static/background.js" defer></script>
</head>
<body>
    <div class="bg-overlay" role="button" tabindex="0" aria-pressed="true" aria-label="Toggle background animation">
        <canvas id="bg-canvas" aria-hidden="true"></canvas>
    </div>
    <div class="page-wrap">
        <div class="card">
            <div class="card-header">
                <div>
                    <h1>3270Web</h1>
                    <div class="subtle">Connect to a TN3270 host</div>
                </div>
                <div class="toolbar">
                    {{ if .SampleApps }}
                    <button type="button" data-open-sample-modal>Start Sample App</button>
                    {{ end }}
                    <label for="theme-select">Theme</label>
                    <select id="theme-select"></select>
                </div>
            </div>
            {{ if .ConnectError }}
            <div class="alert">
                <strong>Connection error</strong>
                <span>{{ .ConnectError }}</span>
            </div>
            {{ end }}
            <form action="/connect" method="post" id="connect-form">
                <fieldset class="connect-row">
                    <label for="hostname-input">Hostname / IP</label>
                    <input id="hostname-input" type="text" name="hostname" value="{{ .DefaultHost }}" data-host-input required autofocus placeholder="hostname:port">
                    <button type="submit" id="connect-btn">Connect</button>
                </fieldset>
            </form>
        </div>
    </div>
    {{ if .SampleApps }}
    <div class="modal-backdrop" data-sample-modal hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sample-app-title">
            <div class="modal-header">
                <h3 id="sample-app-title">Start Sample App</h3>
                <button type="button" class="modal-close" data-sample-close>Close</button>
            </div>
            <div class="stack">
                <label for="sample-app-select">Sample application</label>
                <select id="sample-app-select">
                    {{ range .SampleApps }}
                    <option value="{{ .ID }}">{{ .Name }}</option>
                    {{ end }}
                </select>
                <label for="sample-app-port">Port</label>
                <select id="sample-app-port">
                    {{ range .SamplePorts }}
                    <option value="{{ . }}">{{ . }}</option>
                    {{ end }}
                </select>
                <button type="button" data-sample-start>Start Sample App</button>
            </div>
        </div>
    </div>
    {{ end }}
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const hostInput = document.querySelector("[data-host-input]");
            const modal = document.querySelector("[data-sample-modal]");
            const openModal = document.querySelector("[data-open-sample-modal]");
            const closeModal = document.querySelector("[data-sample-close]");
            const startButton = document.querySelector("[data-sample-start]");
            const appSelect = document.querySelector("#sample-app-select");
            const portSelect = document.querySelector("#sample-app-port");
            const connectForm = document.getElementById("connect-form");
            const connectBtn = document.getElementById("connect-btn");

            const setLoading = () => {
                if (connectBtn) {
                    connectBtn.innerHTML = '<span class="spinner" aria-hidden="true"></span> Connecting...';
                    connectBtn.setAttribute('aria-busy', 'true');
                    connectBtn.disabled = true;
                }
            };

            if (connectForm) {
                connectForm.addEventListener("submit", (e) => {
                    setLoading();
                });
            }

            let lastFocusedElement;
            const hideModal = () => {
                if (modal) {
                    modal.hidden = true;
                    if (lastFocusedElement) {
                        lastFocusedElement.focus();
                        lastFocusedElement = null;
                    }
                }
            };

            if (openModal && modal) {
                openModal.addEventListener("click", () => {
                    lastFocusedElement = document.activeElement;
                    modal.hidden = false;
                    const firstInput = modal.querySelector('select, input, button:not(.modal-close)');
                    if (firstInput) {
                        firstInput.focus();
                    }
                });
            }
            if (closeModal) {
                closeModal.addEventListener("click", hideModal);
            }
            if (modal) {
                modal.addEventListener("click", (event) => {
                    if (event.target === modal) {
                        hideModal();
                    }
                });
            }
            const allowedAppIds = appSelect
                ? new Set(Array.from(appSelect.options).map((option) => option.value))
                : null;
            const allowedPorts = portSelect
                ? new Set(Array.from(portSelect.options).map((option) => Number(option.value)))
                : null;

            if (startButton && hostInput && appSelect && portSelect) {
                startButton.addEventListener("click", () => {
                    const appId = appSelect.value || "";
                    const port = Number(portSelect.value || 0);
                    if (!allowedAppIds || !allowedPorts || !allowedAppIds.has(appId) || !allowedPorts.has(port)) {
                        return;
                    }
                    hostInput.value = "sampleapp:" + appId + ":" + port;
                    hideModal();
                    if (hostInput.form) {
                        setLoading();
                        hostInput.form.submit();
                    }
                });
            }
            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape" && modal && !modal.hidden) {
                    hideModal();
                }
            });
        });
    </script>
</body>
</html>
